#!/bin/sh

# tvim
# Maintainer:	kyoh86
# License:		MIT License(http://www.opensource.org/licenses/MIT)

tmpfile=$(mktemp)

echo "\033]51;[\"call\", \"Tapi_EditermEditFile\", [\"${VIM_EDITERM_OPENER}\", \"${tmpfile}\", \"$1\"]]\007"

if command -v inotifywait >/dev/null; then
  inotifywait "${tmpfile}"
elif command -v fswatch >/dev/null; then
  fswatch -1 -0 --format '' "${tmpfile}"
else
  while true; do
    if [ ! -f "${tmpfile}" ]; then
      break
    fi
    if [ -n "${tmpfile}" ]; then
      break
    fi
    sleep 1
  done
fi

if [ -n "${tmpfile}" ]; then
  while read -r line; do
    if [ "${line}" = "" ]; then
      continue
    fi
    exit $((line))
  done < "${tmpfile}"
fi
rm "${tmpfile}"
